package project.controllers.popupcontrollers;


import ca.mcgill.comp361.splendormodel.actions.Action;
import ca.mcgill.comp361.splendormodel.actions.CardExtraAction;
import ca.mcgill.comp361.splendormodel.model.CardEffect;
import ca.mcgill.comp361.splendormodel.model.Colour;
import ca.mcgill.comp361.splendormodel.model.DevelopmentCard;
import ca.mcgill.comp361.splendormodel.model.NobleCard;
import ca.mcgill.comp361.splendormodel.model.PlayerInGame;
import ca.mcgill.comp361.splendormodel.model.Position;
import java.net.URL;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.stream.Collectors;
import javafx.event.EventHandler;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.scene.Group;
import javafx.scene.Node;
import javafx.scene.control.Label;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.scene.paint.Color;
import javafx.scene.shape.Rectangle;
import javafx.stage.Stage;
import project.App;
import project.connection.GameRequestSender;
import project.view.splendor.boardgui.ActionIdPair;

/**
 * Purchase controller class, controls the visual updates happening in purchase hand.
 * associated with "purchase_hand.fxml"
 */
public class PurchaseHandController implements Initializable {

  private final Map<Colour, Group> colourGroupMap;
  private final Map<Colour, List<DevelopmentCard>> colourCardsMap;
  private final List<NobleCard> nobleCards;
  private final Map<String, Action> playerActions;
  private final long gameId;

  private final PlayerInGame playerInGame;
  @FXML
  // each index represent the group of displaying all cards of one colour
  // there are 6 colours to display (hold the Groups)
  private HBox cardStackHbox;
  @FXML
  // place to store the gold token cards.
  // hold the Gold->List<DevCards>
  private VBox goldTokenCardsVbox;
  @FXML
  // hold List<NobleCard>
  private VBox noblesUnLocked;

  @FXML
  private Label ownershipLabel;

  @FXML
  private Label cardCountLabel;

  /**
   * PurchaseHandController.
   *
   * @param playerInGame  playerInGame
   * @param playerActions playerActions
   */
  public PurchaseHandController(long gameId, PlayerInGame playerInGame,
                                Map<String, Action> playerActions) {
    // organize all dev cards (including gold colour ones) into colour map
    this.gameId = gameId;
    this.playerInGame = playerInGame;
    List<DevelopmentCard> allCardsInHand = playerInGame.getPurchasedHand().getDevelopmentCards();
    this.colourCardsMap = reorganizeCardsInHand(allCardsInHand);
    this.colourGroupMap = new HashMap<>();
    this.nobleCards = playerInGame.getPurchasedHand().getNobleCards();
    this.playerActions = playerActions;
  }


  /**
   * Put cards in different groups based on colour type.
   * The colour can be gold.
   *
   * @param allDevCards allDevCards
   * @return return a map
   */
  private Map<Colour, List<DevelopmentCard>> reorganizeCardsInHand(
      List<DevelopmentCard> allDevCards) {
    Map<Colour, List<DevelopmentCard>> result = new HashMap<>();
    for (DevelopmentCard card : allDevCards) {
      if (!result.containsKey(card.getGemColour())) {
        // initialize the list for cards
        List<DevelopmentCard> cardsOfOneColour = new ArrayList<>();
        cardsOfOneColour.add(card);
        result.put(card.getGemColour(), cardsOfOneColour);
      } else {
        // if result contains this colour before, then we just
        // need to add this card to the list the colour maps to
        //TODO: We need to sort them LATER!!!!
        result.get(card.getGemColour()).add(card);
      }
    }
    return result;
  }

  // Add the satchel mark display to every dev card (exclude the orient gold card)
  private List<HBox> generateCardSatchelPair(
      List<DevelopmentCard> oneColourCards,
      Map<Position, List<ActionIdPair>> positionSatchelActionMap) {

    List<HBox> result = new ArrayList<>();
    for (DevelopmentCard card : oneColourCards) {
      Rectangle satchelMark = new Rectangle();
      // Colour will be assigned differently if the card is linked
      if (card.isPaired()) {
        satchelMark.setFill(Color.BLUE);
        // tooltip only if the card is paired
        String hintOnMark = "This card is paired! No reverse!";
        App.bindToolTip(hintOnMark, 15, satchelMark, 20);
      } else {
        satchelMark.setFill(Color.WHITESMOKE);
      }
      Image img;
      // has some effect -> orient
      if (!card.isBaseCard()) {
        img = new Image(App.getOrientCardPath(card.getCardName(), card.getLevel()));
      } else { // otherwise, base
        img = new Image(App.getBaseCardPath(card.getCardName(), card.getLevel()));
      }
      ImageView imgV = new ImageView(img);
      imgV.setFitWidth(100);
      imgV.setFitHeight(150);
      satchelMark.setWidth(15);
      satchelMark.setHeight(150);

      // if we have some pair actions, assign them
      if (!positionSatchelActionMap.isEmpty()) {
        List<List<ActionIdPair>> satchelActions = positionSatchelActionMap.values().stream()
            .filter(e -> ((CardExtraAction) e.get(0).getAction()).getCurCard().equals(card))
            .collect(Collectors.toList());
        if (satchelActions.size() > 0) {
          imgV.setOnMouseClicked(createClickOnCardToPair(gameId, satchelActions.get(0)));
        }
      }
      HBox container = new HBox(imgV, satchelMark);
      result.add(container);
    }
    return result;
  }

  // display it a bit inclined
  private void addCardSatchelPairToColourGroup(
      List<HBox> cardSatchelPairs, Group groupOfOneColour) {

    for (HBox pair : cardSatchelPairs) {
      groupOfOneColour.getChildren().add(pair);
    }

    int i = 0;
    for (Node n : groupOfOneColour.getChildren()) {
      n.setLayoutX(i * 15);
      n.setLayoutY(i * 25);
      i += 1;
    }
  }

  private void addGoldTokenCards(List<DevelopmentCard> goldTokenCards, VBox goldTokenCardsVbox) {
    if (goldTokenCards != null && goldTokenCards.size() > 0) {
      for (DevelopmentCard card : goldTokenCards) {
        String cardPath = App.getOrientCardPath(card.getCardName(), card.getLevel());
        Image image = new Image(cardPath);
        ImageView imageView = new ImageView(image);
        imageView.setFitWidth(100);
        imageView.setFitHeight(150);
        // add the image view to vbox
        goldTokenCardsVbox.getChildren().add(imageView);
      }
    }
  }

  private void addNobleCards(List<NobleCard> nobleCards, VBox noblesUnLocked) {
    for (NobleCard nobleCard : nobleCards) {
      String noblePath = App.getNoblePath(nobleCard.getCardName());
      ImageView imageView = new ImageView(new Image(noblePath));
      // add the image view to vbox
      imageView.setFitWidth(120);
      imageView.setFitHeight(120);
      noblesUnLocked.getChildren().add(imageView);
    }
  }


  private EventHandler<MouseEvent> createClickOnCardToPair(long gameId,
                                                           List<ActionIdPair> satchelAction) {
    return event -> {
      // it's clickable, we can send some requests here

      GameRequestSender gameRequestSender = App.getGameRequestSender();
      String playerName = App.getUser().getUsername();
      String accessToken = App.getUser().getAccessToken();
      String actionId = satchelAction.get(0).getActionId();
      // sends a POST request that tells the server which action we chose
      gameRequestSender.sendPlayerActionChoiceRequest(gameId, playerName, accessToken, actionId);
      ImageView imageView = (ImageView) event.getSource();
      Stage curWindow = (Stage) imageView.getScene().getWindow();
      curWindow.close();
    };
  }


  private Map<Position, List<ActionIdPair>> getSatchelActionsInPurchaseHand(
      Map<String, Action> satchelActions) {
    Map<Position, List<ActionIdPair>> positionToActionMap = new HashMap<>();
    // assign actions to positions (each position can have a list of action pair associated)
    for (String actionId : satchelActions.keySet()) {
      Action action = satchelActions.get(actionId);
      Position cardPosition;
      CardExtraAction satchelAction = (CardExtraAction) action;
      cardPosition = satchelAction.getCardPosition();
      List<ActionIdPair> actions = new ArrayList<>();
      actions.add(new ActionIdPair(actionId, action));
      positionToActionMap.put(cardPosition, actions);
    }

    return positionToActionMap;
  }


  @Override
  public void initialize(URL url, ResourceBundle resourceBundle) {
    if (App.getUser().getUsername().equals(playerInGame.getName())) {
      ownershipLabel.setText("My Development Cards and Nobles");
    } else {
      String title = String.format("%s's Development Cards and Nobles", playerInGame.getName());
      ownershipLabel.setText(title);
    }

    cardCountLabel.setText(cardCountLabel.getText() + " "
        + playerInGame.getPurchasedHand().getDevelopmentCards().size());

    Map<String, Action> satchelActions = new HashMap<>();
    for (String actionId : playerActions.keySet()) {
      Action action = playerActions.get(actionId);
      if (action instanceof CardExtraAction) {
        CardExtraAction cardExtraAction = (CardExtraAction) action;
        if (cardExtraAction.getCardEffect().equals(CardEffect.SATCHEL)) {
          satchelActions.put(actionId, action);
        }
      }
    }


    Map<Position, List<ActionIdPair>> positionSatchelActionMap = new HashMap<>();
    if (satchelActions.size() > 0) {
      positionSatchelActionMap = getSatchelActionsInPurchaseHand(satchelActions);
    }

    Colour[] baseColours = App.getBaseColours();
    // the groups are stored in HBox in FXML file, there are 6 elements in the HBox
    // the first 5 are groups that store regular dev cards
    // the 6th element is the VBox storing gold orient cards
    for (int i = 0; i < 5; i++) {
      Colour curColour = baseColours[i];
      Group colourGroup = (Group) cardStackHbox.getChildren().get(i);
      // store a colour map look up reference to the GUI group so that it
      // is easier to have access to it rather than counting the index from 0 to 4
      colourGroupMap.put(curColour, colourGroup);
    }

    // add the gold colour cards' image views to vbox
    List<DevelopmentCard> goldTokenCards = colourCardsMap.get(Colour.GOLD);
    addGoldTokenCards(goldTokenCards, goldTokenCardsVbox);

    for (Colour c : colourGroupMap.keySet()) {
      if (colourCardsMap.containsKey(c)) {
        List<DevelopmentCard> cardsOfOneColour = colourCardsMap.get(c);
        List<DevelopmentCard> sortedCards = cardsOfOneColour.stream()
            .sorted(Comparator.comparingInt(DevelopmentCard::getPrestigePoints))
            .collect(Collectors.toList());
        List<HBox> allPairs = generateCardSatchelPair(sortedCards, positionSatchelActionMap);
        addCardSatchelPairToColourGroup(allPairs, colourGroupMap.get(c));
      }
    }

    // display the noble cards to GUI
    addNobleCards(nobleCards, noblesUnLocked);

  }
}
